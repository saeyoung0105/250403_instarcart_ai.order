import streamlit as st
import pandas as pd
import ast  # ë¬¸ìì—´ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ì•ˆì „í•˜ê²Œ ë³€í™˜

# ------------------------------
# 1. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
# ------------------------------
@st.cache_data
def load_data():
    file_path = file_path = "ì¶©ì„±ê³ ê°_ì¶”ì²œë°ì´í„°.xlsx"

    return pd.read_excel(file_path)

df = load_data()

# ------------------------------
# 2. íƒ€ì´í‹€ ë° ì†Œê°œ ë¬¸êµ¬
# ------------------------------
st.title("Instacart ê³ ê° ë§ì¶¤í˜• AI ì¥ë°”êµ¬ë‹ˆ íŠ¸ë ˆì ¸ë´‡ ğŸ¤–")
st.markdown("""
### ì•ˆë…•í•˜ì„¸ìš” ğŸ‘‹  
Instacart ê³ ê° ë§ì¶¤í˜• AI ì¥ë°”êµ¬ë‹ˆ íŠ¸ë ˆì ¸ë´‡ì…ë‹ˆë‹¤!  
ê³ ê°ë‹˜ê»˜ ê¼­ ë§ëŠ” ìƒí’ˆì„ ì¶”ì²œí•´ë“œë¦´ê²Œìš” ğŸ˜Š
""")

# ------------------------------
# 3. í•¸ë“œí° ë²ˆí˜¸ ì…ë ¥ (user_idë¡œ ì‚¬ìš©)
# ------------------------------
phone_number = st.text_input("ğŸ“± í•¸ë“œí° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ê³ ê° ì‹ë³„ìš©):")

# ------------------------------
# 4. ê³ ê° ë°ì´í„° ì¡°íšŒ
# ------------------------------
if phone_number:
    try:
        user_id = int(phone_number)  # ì˜ˆ: ì „í™”ë²ˆí˜¸ë¥¼ user_idë¡œ ì‚¬ìš©
        user_data = df[df['user_id'] == user_id]

        if not user_data.empty:
            st.success(f"{user_id}ë²ˆ ê³ ê°ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!")

            # 1) ìµœê·¼ ì¥ë°”êµ¬ë‹ˆ top 5 aisles
            st.subheader("ğŸ§º ìµœê·¼ ì¥ë°”êµ¬ë‹ˆ Top 5 Aisles")
            st.write(user_data.iloc[0]['top_5_aisles'])

            # 2) ë²ˆë“¤ ì¶”ì²œ UI
            st.subheader("ğŸ ì¶”ì²œ ë²ˆë“¤ ìƒí’ˆ")

            bundle_options = [
                "ì•„ì¹¨ ë£¨í‹´ ë²ˆë“¤", "ê±´ê°• ì±„ì†Œ ë²ˆë“¤", "ê°„í¸ ë„ì‹œë½ ë²ˆë“¤", "ê°„ì‹ íƒ€ì„ ë²ˆë“¤", "ì–´ë¦°ì´ ê°„ì‹ ë²ˆë“¤",
                "ëƒ‰ë™ì‹í’ˆ ì„¸íŠ¸", "ë””ì €íŠ¸ ë²ˆë“¤", "ì €íƒ„ê³ ì§€ ë²ˆë“¤", "ìœ¡ë¥˜ ì£¼ë§ ë²ˆë“¤", "ì±„ì‹ì£¼ì˜ ë²ˆë“¤",
                "í´ë¦°í™ˆ ë²ˆë“¤", "ìœ ì œí’ˆ ë¬¶ìŒ", "ì•„ì‹œì•ˆ í‘¸ë“œ ë²ˆë“¤", "ëƒ‰ì¥ í•„ìˆ˜ ë²ˆë“¤", "í•´ì¥ ì„¸íŠ¸",
                "ì™€ì¸ ì•ˆì£¼ ë²ˆë“¤", "ë·°í‹° ì¼€ì–´ ë²ˆë“¤", "ë°˜ë ¤ë™ë¬¼ ë²ˆë“¤", "ë””í†¡ìŠ¤ ë²ˆë“¤", "ë¹„ìƒìƒë¹„ì•½ ë²ˆë“¤" ]

            try:
                # ë¬¸ìì—´ì´ë©´ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
                bundle_value = user_data.iloc[0]['ë²ˆë“¤ì¶”ì²œìƒí’ˆ']
                prev_bundles = ast.literal_eval(bundle_value) if isinstance(bundle_value, str) else bundle_value
            except:
                prev_bundles = []

            selected_bundles = st.multiselect(
                "ğŸ‘‡ ì›í•˜ì‹œëŠ” ë²ˆë“¤ì„ ì„ íƒí•´ì£¼ì„¸ìš” (ìµœëŒ€ 3ê°œ)",
                bundle_options,
                default=prev_bundles,
                max_selections=3
            )

            # 3) ê³ ê° ì…ë ¥ë€
            st.subheader("ğŸ“‹ ê³ ê°ë‹˜ì˜ ì·¨í–¥ì„ ì•Œë ¤ì£¼ì„¸ìš”")

            allergy = st.text_area("â— ì•ŒëŸ¬ì§€ê°€ ìˆìœ¼ì‹ ê°€ìš”?", placeholder="ì˜ˆ: ê²¬ê³¼ë¥˜, í•´ì‚°ë¬¼ ë“±")
            dislike = st.text_area("ğŸ™… ì‹«ì–´í•˜ëŠ” ìŒì‹ì´ë‚˜ ì¬ë£Œ", placeholder="ì˜ˆ: ì½©, ê±´í¬ë„ ë“±")
            like = st.text_area("ğŸ‘ ì¢‹ì•„í•˜ëŠ” ìŒì‹ì´ë‚˜ ì¬ë£Œ", placeholder="ì˜ˆ: ì´ˆì½œë¦¿, ë‹­ê³ ê¸° ë“±")
            feedback = st.text_area("ğŸ› ï¸ ê°œì„ ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ì ", placeholder="ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”")

            # 4) ì œì¶œ ë²„íŠ¼
            if st.button("âœ… ì œì¶œí•˜ê¸°"):
                st.success("ê°ì‚¬í•©ë‹ˆë‹¤! ê³ ê°ë‹˜ì˜ ì •ë³´ê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ™Œ")
                st.write("**ì„ íƒí•œ ë²ˆë“¤ ì¶”ì²œ ìƒí’ˆ:**", selected_bundles)
                st.write("**ì•ŒëŸ¬ì§€:**", allergy)
                st.write("**ì‹«ì–´í•˜ëŠ” í•­ëª©:**", dislike)
                st.write("**ì¢‹ì•„í•˜ëŠ” í•­ëª©:**", like)
                st.write("**ê°œì„ ì‚¬í•­:**", feedback)

        else:
            st.error("âŒ í•´ë‹¹ ê³ ê° ë²ˆí˜¸ì— ëŒ€í•œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    except ValueError:
        st.warning("âš ï¸ ìˆ«ìë¡œ ëœ í•¸ë“œí° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
